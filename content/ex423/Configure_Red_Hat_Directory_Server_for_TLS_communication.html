---
title: Configure Red Hat Directory Server for TLS communication
objective: 5
category: EX423
---

In order for this objective to be practiced realistically, you need a few things, including a signed certificate from a CA. I'm sure on the exam that we will be able to just generate a CSR and get a cert back, since there are no objectives for setting up a CA. This is all speculation though, as I have yet to take the test myself and have no idea whats on it. I know that openldap pukes if you try and use a self-signed certificate, without adding "TLS_REQCERT allow" into the conf file. 

So to be thorough, I setup a CA on a seperate EC2 instance. Checkout the guide if you want to go that extra mile while studying. [http://makewhatis.com/2012/04/setting-up-simple-ca-openssl](http://makewhatis.com/2012/04/setting-up-simple-ca-openssl)

### Generate a certificate request and submit CSR to CA

Although this is one of the steps to getting this working, its actually covered in a different objective. Check out the "[Request a certificate from a certificate authority (CA)](http://dev.rhca.co/ex423/Request_a_certificate_from_a_certificate_authority__CA_.html)" page for this step.

### Install the certificates

This is also covered in another objective. Its a prereq to getting this one working, so check that out at: [Install CA-signed server certificate](http://rhca.co/ex423/Install_CA-signed_server_certificate.html)

### Enable TLS on the Directory Admin

Finally, TLS can be enabled. In the Directory Server Console, choose the Configuration tab, and highlight the server name on the left. Choose encryption and check the box for SSL and "Use this cipher family: RSA". You should see your certificate in there now, but you may have to reconnect to see it. At least I did, for some reason it wouldnt show up until I reopened the console. 

Once you are able to see your certificate and choose it, then you can restart your Directory Server. From the Tasks tab choose the "Restart Directory Server" option, and wait for it to restart. 

Now configure your clients to use TLS, and make sure they have the CA certs installed, and you should be connecting over TLS.

### Enable TLS on a client

To enable TLS on the client, all that needs to happen is the cacert be imported, and openldap be told where to find it. 

CA certs go in /etc/openldap/cacerts/. Whatever you name your CA cert, make sure you update the ldap.conf.

    [root@client01 openldap]# vim /etc/openldap/ldap.conf

Add

    BASE    dc=makewhatis,dc=com
    URI ldap://dc03.makewhatis.com
    TLS_CACERT /etc/openldap/cacerts/cacert.crt

*Note: if you dont do tell openldap where to find the cacert, then when trying to do an ldapsearch with TLS enabled, -ZZ, then you will get the following error*:

    [root@client01 openldap]# ldapsearch -ZZ -x
    ldap_start_tls: Connect error (-11)
    additional info: error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed

### Configure Autostart without password

To do this there needs to be a pin/password file for each instance so that the app can read it during startup. Otherwise your server will hang on boot while it waits for you to enter the password. 


**For Directory Server**

Create /etc/dirsrv/slapd-instance_name/pin.txt (substitute slapd-instance_name for actual server instance's directory name):
    
    touch /etc/dirsrv/slapd-instance_name/pin.txt
    chmod 600 /etc/dirsrv/slapd-instance_name/pin.txt
    chown ldap /etc/dirsrv/slapd-instance_name/pin.txt

Edit the pin.txt file and place a single line in it (notice the difference in internal token name between this and Admin Server's):

    Internal (Software) Token:dirserv_cert_password

That's it. Restart the server to test whether it doesn't ask for the PIN anymore and starts up properly with SSL.

**For Admin Server**

The admin is a bit different than other dirsrv instances.

Edit /etc/dirsrv/admin-serv/nss.conf and change NSSPassPhraseDialog to read:

    NSSPassPhraseDialog  file://///etc/dirsrv/admin-serv/password.conf

Then create /etc/dirsrv/admin-serv/password.conf:
    
    touch /etc/dirsrv/admin-serv/password.conf
    chmod 600 /etc/dirsrv/admin-serv/password.conf
    chown ldap /etc/dirsrv/admin-serv/password.conf

Edit /etc/dirsrv/admin-serv/password.conf and place this single line in there:
    
    internal:adminserv_cert_password

