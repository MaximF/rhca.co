---
title: Migrate NIS users and groups into LDAP
objective: 14
category: EX423
---

Migrating users from NIS to LDAP. 

Setup NIS Server. 
-----------------

I used a server called nis.makewhatis.com on EC2, in order to setup a fake nis instance to practice moving users. I haven't really had to deal with NIS at all at a job yet, so that part is all new. 

I used this guide to set it up, changing the info for myself. [http://www.server-world.info/en/note?os=CentOS_5&p=nis](http://www.server-world.info/en/note?os=CentOS_5&p=nis)

    [root@nis ~]# yum -y install ypserve
    [root@nis ~]# ypdomainname nis.makewhatis.com
    [root@nis ~]# vim /etc/sysconfig/network
    NETWORKING=yes
    NETWORKING_IPV6=no
    HOSTNAME=nis.makewhatis.com
    NISDOMAIN=nis.makewhatis.com

    [root@nis ~]# vim /var/yp/Makefile
    # MERGE_PASSWD=true|false
    # line 42: change
    MERGE_PASSWD=false
    # MERGE_GROUP=true|false
    # line 46: change
    MERGE_GROUP=false
    # line 117: add if not already there.
    all: passwd shadow group hosts rpc services netid protocols

    [root@nis ~]# vim /var/yp/securenets
     255.255.255.0   10.0.0.0

    [root@nis ~]# vim /etc/hosts
    # add own IP address
    10.172.9.100      nis.makewhatis.com nis

    [root@nis ~]# /sbin/service portmap start 
    Starting portmap: [ OK ]
    [root@nis ~]# /sbin/service ypserv start 
    Starting YP server services: [  OK  ]
    [root@nis ~]# /etc/init.d/yppasswdd start 
    Starting YP passwd service: [  OK  ]
    [root@nis ~]# chkconfig portmap on 
    [root@nis ~]# chkconfig ypserv on 
    [root@nis ~]# chkconfig yppasswdd on
    [root@nis ~]# /usr/lib64/yp/ypinit -m # update NIS database
    At this point, we have to construct a list of the hosts which will run NIS
    servers. dir.server.world is in the list of NIS server hosts. Please continue to add
    the names for the other hosts, one per line. When you are done with the
    list, type a <control D>.
    next host to add: nis.makewhatis.com
    next host to add:# push Ctrl + D key
    The current list of NIS servers looks like this:

    nis.makewhatis.com

    Is this correct?  [y/n: y]  y
    We need a few minutes to build the databases...
    Building /var/yp/nis.makewhatis.com/ypservers...
    Running /var/yp/Makefile...
    gmake[1]: Entering directory `/var/yp/nis.makewhatis.com'
    Updating passwd.byname...
    Updating passwd.byuid...
    Updating group.byname...
    Updating group.bygid...
    Updating hosts.byname...
    Updating hosts.byaddr...
    Updating rpc.byname...
    Updating rpc.bynumber...
    Updating services.byname...
    Updating services.byservicename...
    Updating netid.byname...
    Updating protocols.bynumber...
    Updating protocols.byname...
    Updating mail.aliases...
    gmake[1]: Leaving directory `/var/yp/nis.makewhatis.com'

    nis.makewhatis.com has been set up as a NIS master server.

    Now you can run ypinit -s nis.makewhatis.com on all slave server.

    # It's neccessary to update NIS database with following way if new user is added again
    [root@nis ~]# cd /var/yp 
    [root@dir yp]# make 

For this to work on EC2 with my firewalls, I had to bind the service to a specific port. On the server this part was a bit more straighforward than the client, as the config was set in sysconfig.

    [root@nis yp]# vim /etc/sysconfig/network
    #added 
    YPSERV_ARGS="--port 647"


Installing the client. I setup a nis-client.makewhatis.com host to test this out on. First time I did this on my LDAP client and did something funky to authentication, so this time I just used another instance for a couple hours. 

Again I just used steps found on the same site, targeted for client setup. [http://www.server-world.info/en/note?os=CentOS_5&p=nis&f=2](http://www.server-world.info/en/note?os=CentOS_5&p=nis&f=2)

    [root@nis-client ~]# yum -y install ypbind
    [root@nis-client ~]# vim /etc/sysconfig/network
    NETWORKING=yes
    NETWORKING_IPV6=no
    HOSTNAME=nis-client.makewhatis.com
    # add at the last line
    NISDOMAIN=nis.makewhatis.com

    [root@nis-client ~]# vim /etc/sysconfig/authconfig
    USENIS=yes# line 19: change

    [root@nis-client ~]# vim /etc/yp.conf
    # dd at the last line ( [domain] server [NIS server] )
    domain nis.makewhatis.com server nis.makewhatis.com

    [root@nis-client ~]# vim /etc/nsswitch.conf
    passwd:files nis# line 33: add
    shadow:files nis# add
    group:files nis# add
    hosts:files dns nis# add
    # add optionally if you need ( create home directory automatically if it's none )

    [root@nis-client ~]# vim /etc/pam.d/system-auth
    # add at the last line
    session     optional      pam_mkhomedir.so skel=/etc/skel umask=077 


I had to bind this service to a specific port inside of the init script, since I am using EC2 and only want one port open. I chose 647, like the server. 

    [root@nis-client ~]# vim /etc/init.d/ypbind
    #added -p 647 in OPTS
    OTHER_YPBIND_OPTS="-p 647"
    [root@nis-client ~]# service ypbind restart
    [root@nis-client ~]# rpcinfo -p
    program vers proto   port
    100000    2   tcp    111  portmapper
    100000    2   udp    111  portmapper
    100007    2   udp    647  ypbind
    100007    1   udp    647  ypbind
    100007    2   tcp    647  ypbind
    100007    1   tcp    647  ypbind

    [root@nis-client ~]# chkconfig portmap on 
    [root@nis-client ~]# chkconfig ypbind on 
    [root@nis-client ~]# shutdown -r now

Upon reboot of your server, you should be able to log in as a user from the nis server to the client. 

    nis-client.makewhatis.com login: david# user on NIS
    Password:# password
    Creating directory '/home/david'.

    [david@nis-client ~]$ ypwhich 
    nis.makewhatis.com

    [david@nis-client ~]$ ypcat passwd
    david:x:502:502::/home/david:/bin/bash
    ec2-user:x:500:500::/home/ec2-user:/bin/bash

    [david@nis-client ~]$ ypcat hosts
    10.172.9.111    nis.makewhatis.com nis
    127.0.0.1       localhost.localdomain localhost
    127.0.0.1       localhost.localdomain localhost
    10.172.9.111     nis.makewhatis.com nis

We can even change the password of our user from NIS, on the client. 

    [david@nis-client ~]$ yppasswd
    Changing NIS account information for david on nis.makewhatis.com.
    Please enter old password:
    Changing NIS password for david on nis.makewhatis.com.
    Please enter new password:
    Please retype new password:

    The NIS password has been changed on nis.makewhatis.com.

    [david@nis-client ~]$ exit


Export users to ldif
--------------------


